name: UI Monitor (daily)

on:
  schedule:
    - cron: "0 7 * * *"   # 07:00 UTC (~12:30 IST). Change if needed.
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: "1"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install opencv-python-headless scikit-image imagehash pillow pandas pydrive2 requests

      # 1) Pull screenshots from Google Drive (Shared Drive) to local workspace
      - name: Pull screenshots from Drive (Shared Drive)
        env:
          GDRIVE_SERVICE_ACCOUNT_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
          INPUT_DRIVE_FOLDER_ID: ${{ secrets.INPUT_DRIVE_FOLDER_ID }}
        run: |
          python - << 'PY'
          import os
          from tools.drive_sync import drive_client_from_service_account_json, download_folder_tree
          sa_json = os.environ["GDRIVE_SERVICE_ACCOUNT_JSON"]
          input_root_id = os.environ["INPUT_DRIVE_FOLDER_ID"]
          drive = drive_client_from_service_account_json(sa_json)
          download_folder_tree(drive, input_root_id, "data/screenshots")
          print("✅ Downloaded screenshots into data/screenshots")
          PY

      # 2) Compare last-two images per folder; copy both originals + make heatmaps/CSV/HTML
      - name: Compare latest pairs
        env:
          INPUT_LOCAL_ROOT: data/screenshots
          REPORT_LOCAL_ROOT: out/diffs
          SSIM_THRESHOLD: "0.985"
          PHASH_THRESHOLD: "8"
        run: |
          python tools/compare_latest_pair.py

      # 3) Upload the new run_... folder back to Drive and make it shareable
      - name: Upload run folder to Drive & expose share link
        id: upload
        env:
          GDRIVE_SERVICE_ACCOUNT_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT_JSON }}
          REPORTS_PARENT_FOLDER_ID: ${{ secrets.REPORTS_PARENT_FOLDER_ID }}
        run: |
          python - << 'PY'
          import os
          from pathlib import Path
          from tools.drive_sync import drive_client_from_service_account_json, upload_run_folder
          sa_json = os.environ["GDRIVE_SERVICE_ACCOUNT_JSON"]
          reports_parent_id = os.environ["REPORTS_PARENT_FOLDER_ID"]
          drive = drive_client_from_service_account_json(sa_json)
          runs = sorted([p for p in Path("out/diffs").glob("run_*") if p.is_dir()])
          assert runs, "No run folder found in out/diffs"
          latest = runs[-1]
          link = upload_run_folder(drive, reports_parent_id, latest.as_posix())
          print("RUN_LINK::", link)
          # pass to downstream steps
          with open(os.environ["GITHUB_OUTPUT"], "a") as fh:
            fh.write(f"link={link}\n")
          PY

      # 4) (Optional) Post digest to ClickUp Chat channel when secrets are present
      - name: Post to ClickUp channel (optional)
        env:
          CLICKUP_TOKEN: ${{ secrets.CLICKUP_TOKEN }}
          CLICKUP_WORKSPACE_ID: ${{ secrets.CLICKUP_WORKSPACE_ID }}
          CLICKUP_CHANNEL_ID: ${{ secrets.CLICKUP_CHANNEL_ID }}
        if: ${{ env.CLICKUP_TOKEN != '' && env.CLICKUP_WORKSPACE_ID != '' && env.CLICKUP_CHANNEL_ID != '' }}
        run: |
          python - << 'PY'
          import os, pandas as pd, requests
          from pathlib import Path

          # --- Build the message (always a plain string, trimmed safely) ---
          runs = sorted([p for p in Path("out/diffs").glob("run_*") if p.is_dir()])
          latest = runs[-1]
          csv_path = latest / "summary.csv"

          df = pd.read_csv(csv_path)
          changed = df[df["changed"] == True].copy()
          title_time = latest.name.replace("run_", "").replace("_", " ")
          lines = [f"Daily UI review — {title_time}"]

          if len(changed):
            lines.append("Changes detected:")
            for _, r in changed.iterrows():
              zone = f" Likely area: {r['likely_zone']}." if isinstance(r['likely_zone'], str) and r['likely_zone'] else ""
              # keep per-line reasonably short
              lines.append(f"• UI/UX of {str(r['page'])} has been changed compared to the previous capture.{zone}")
          else:
            lines.append("No UI/UX changes detected across monitored pages.")

          link = "${{ steps.upload.outputs.link }}"
          lines.append("\nFull report, heatmaps, and both source images in:")
          lines.append(str(link))

          message = "\n".join(lines)
          # Hard cap to avoid ClickUp 40k char limit; keep a bit of headroom
          if len(message) > 38000:
            message = message[:37950] + "\n…(truncated)"

          # --- Post to ClickUp Chat channel (try both payload shapes) ---
          token = os.environ["CLICKUP_TOKEN"]
          ws_id = os.environ["CLICKUP_WORKSPACE_ID"]
          ch_id = os.environ["CLICKUP_CHANNEL_ID"]

          base_url = f"https://api.clickup-stg.com/api/v3/workspaces/{ws_id}/chat/channels/{ch_id}/messages"
          headers = {"Authorization": token, "Content-Type": "application/json"}

          def try_post(payload):
            try:
              r = requests.post(base_url, headers=headers, json=payload, timeout=30)
              return r.status_code, r.text
            except Exception as e:
              return 599, str(e)

          # 1) Standard chat payload
          code, body = try_post({"text": message})
          print("ClickUp attempt#1 (text) ->", code)
          if code >= 300:
            print("Response:", body[:400])

            # 2) Alternate payload some orgs expect
            code2, body2 = try_post({"content": message})
            print("ClickUp attempt#2 (content) ->", code2)
            if code2 >= 300:
              print("Response:", body2[:400])
              raise SystemExit("Failed to send to ClickUp channel (both payload shapes rejected).")
          PY

      # 5) Keep a copy of the run as a GitHub artifact (handy for debugging)
      - name: Upload run as GitHub artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: ui-diff-run
          path: out/diffs/**
